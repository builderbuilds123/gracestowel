{
	"info": {
		"_postman_id": "payment-capture-flow-v3",
		"name": "Payment Capture Verification Flow",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Create Cart (Storefront)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = pm.response.json();",
							"pm.test(\"Status code is 201 or 200\", function () {",
							"    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
							"});",
							"if (jsonData.cart_id) {",
							"    pm.environment.set(\"cart_id\", jsonData.cart_id);",
							"    console.log(\"Cart ID:\", jsonData.cart_id);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"currency\": \"usd\",\n    \"country_code\": \"us\"\n}"
				},
				"url": {
					"raw": "{{storefront_url}}/api/carts",
					"host": ["{{storefront_url}}"],
					"path": ["api", "carts"]
				}
			}
		},
		{
			"name": "2. Update Cart (Items & Address)",
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"items\": [\n        {\n            \"variantId\": \"{{variant_id}}\",\n            \"quantity\": 1\n        }\n    ],\n    \"shipping_address\": {\n        \"first_name\": \"Test\",\n        \"last_name\": \"Capture\",\n        \"address_1\": \"123 Capture St\",\n        \"city\": \"New York\",\n        \"country_code\": \"us\",\n        \"postal_code\": \"10001\",\n        \"province\": \"NY\"\n    },\n    \"email\": \"test-capture@example.com\"\n}"
				},
				"url": {
					"raw": "{{storefront_url}}/api/carts/{{cart_id}}",
					"host": ["{{storefront_url}}"],
					"path": ["api", "carts", "{{cart_id}}"]
				}
			}
		},
		{
			"name": "3. Get Shipping Options",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = pm.response.json();",
							"if (jsonData.shipping_options && jsonData.shipping_options.length > 0) {",
							"    pm.environment.set(\"shipping_option_id\", jsonData.shipping_options[0].id);",
							"    console.log(\"Shipping Option ID:\", jsonData.shipping_options[0].id);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{storefront_url}}/api/carts/{{cart_id}}/shipping-options",
					"host": ["{{storefront_url}}"],
					"path": ["api", "carts", "{{cart_id}}", "shipping-options"]
				}
			}
		},
		{
			"name": "4. Select Shipping Method",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"option_id\": \"{{shipping_option_id}}\"\n}"
				},
				"url": {
					"raw": "{{base_url}}/store/carts/{{cart_id}}/shipping-methods",
					"host": ["{{base_url}}"],
					"path": ["store", "carts", "{{cart_id}}", "shipping-methods"]
				}
			}
		},
		{
			"name": "5. Create Payment Intent",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = pm.response.json();",
							"if (jsonData.paymentIntentId) {",
							"    pm.environment.set(\"payment_intent_id\", jsonData.paymentIntentId);",
							"    console.log(\"Payment Intent ID:\", jsonData.paymentIntentId);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"paymentIntentId\": null,\n    \"currency\": \"usd\",\n    \"amount\": 2000,\n    \"cartItems\": [\n        {\n            \"variantId\": \"{{variant_id}}\",\n            \"quantity\": 1\n        }\n    ],\n    \"hasCartItems\": true\n}"
				},
				"url": {
					"raw": "{{storefront_url}}/api/payment-intent",
					"host": ["{{storefront_url}}"],
					"path": ["api", "payment-intent"]
				}
			}
		},
		{
			"name": "6. Confirm Payment Intent (Stripe)",
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{stripe_secret_key}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/x-www-form-urlencoded",
						"type": "text"
					}
				],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "payment_method",
							"value": "pm_card_visa",
							"type": "text"
						},
						{
							"key": "return_url",
							"value": "https://localhost:5173/checkout/success",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "https://api.stripe.com/v1/payment_intents/{{payment_intent_id}}/confirm",
					"protocol": "https",
					"host": ["api", "stripe", "com"],
					"path": ["v1", "payment_intents", "{{payment_intent_id}}", "confirm"]
				}
			}
		},
		{
			"name": "7. Wait for Capture Delay (15s)",
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "https://postman-echo.com/delay/15",
					"protocol": "https",
					"host": ["postman-echo", "com"],
					"path": ["delay", "15"]
				}
			}
		},
		{
			"name": "8. Admin Login",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = pm.response.json();",
							"if (jsonData.token) {",
							"    pm.environment.set('admin_token', jsonData.token);",
							"    console.log(\"Admin Token Received\");",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"email\": \"admin@medusa-test.com\",\n    \"password\": \"supersecret\"\n}"
				},
				"url": {
					"raw": "{{base_url}}/auth/user/emailpass",
					"host": ["{{base_url}}"],
					"path": ["auth", "user", "emailpass"]
				}
			}
		},
		{
			"name": "9. Get Latest Order (Admin)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = pm.response.json();",
							"if (jsonData.orders && jsonData.orders.length > 0) {",
							"    // Sort orders by created_at desc if API supports it, or assume latest is last/first",
                            "    // For verified test, filtering by email 'test-capture@example.com' is safer",
							"    var order = jsonData.orders[0];",
							"    console.log(\"Order Found:\", order.id);",
							"    pm.environment.set(\"placed_order_id\", order.id);",
							"    ",
							"    // Verify Capture Status",
							"    console.log(\"Payment Status:\", order.payment_status);",
							"    pm.test(\"Payment Status should be captured\", function () {",
							"        pm.expect(order.payment_status).to.eql(\"captured\");",
							"    });",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{admin_token}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{base_url}}/admin/orders?q=test-capture@example.com&limit=1",
					"host": ["{{base_url}}"],
					"path": ["admin", "orders"],
					"query": [
						{
							"key": "q",
							"value": "test-capture@example.com"
						},
						{
							"key": "limit",
							"value": "1"
						}
					]
				}
			}
		}
	]
}

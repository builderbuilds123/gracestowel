{
	"info": {
		"name": "Checkout Flow E2E",
		"description": "End-to-end test of the checkout flow including cart creation, item addition, shipping rates, and payment intent creation.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "1. Get Products",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = pm.response.json();",
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"if (jsonData.products && jsonData.products.length > 0) {",
							"    var variantId = jsonData.products[0].variants[0].id;",
							"    pm.environment.set(\"variant_id\", variantId);",
							"    console.log(\"Variant ID set to:\", variantId);",
							"} else {",
							"    console.error(\"No products found! Cannot proceed.\");",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{base_url}}/store/products",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"store",
						"products"
					]
				}
			}
		},
		{
			"name": "2. Create Cart",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = pm.response.json();",
							"pm.test(\"Status code is 201 or 200\", function () {",
							"    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
							"});",
							"if (jsonData.cart_id) {",
							"    pm.environment.set(\"cart_id\", jsonData.cart_id);",
							"    console.log(\"Cart ID set to:\", jsonData.cart_id);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"currency\": \"usd\",\n    \"country_code\": \"us\"\n}"
				},
				"url": {
					"raw": "{{storefront_url}}/api/carts",
					"host": [
						"{{storefront_url}}"
					],
					"path": [
						"api",
						"carts"
					]
				}
			}
		},
		{
			"name": "3. Update Cart (Items & Address)",
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"items\": [\n        {\n            \"variantId\": \"{{variant_id}}\",\n            \"quantity\": 1,\n            \"id\": \"temp-id-1\"\n        }\n    ],\n    \"shipping_address\": {\n        \"first_name\": \"John\",\n        \"last_name\": \"Doe\",\n        \"address_1\": \"123 Main St\",\n        \"city\": \"New York\",\n        \"country_code\": \"us\",\n        \"postal_code\": \"10001\",\n        \"province\": \"NY\"\n    }\n}"
				},
				"url": {
					"raw": "{{storefront_url}}/api/carts/{{cart_id}}",
					"host": [
						"{{storefront_url}}"
					],
					"path": [
						"api",
						"carts",
						"{{cart_id}}"
					]
				}
			}
		},
		{
			"name": "4. Get Shipping Options",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"var jsonData = pm.response.json();",
							"pm.test(\"Shipping options returned\", function () {",
							"    pm.expect(jsonData.shipping_options).to.be.an('array');",
							"    pm.expect(jsonData.shipping_options.length).to.be.above(0);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{storefront_url}}/api/carts/{{cart_id}}/shipping-options",
					"host": [
						"{{storefront_url}}"
					],
					"path": [
						"api",
						"carts",
						"{{cart_id}}",
						"shipping-options"
					]
				}
			}
		},
		{
			"name": "5. Create Payment Intent",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"var jsonData = pm.response.json();",
							"pm.test(\"Client Secret returned\", function () {",
							"    pm.expect(jsonData.clientSecret).to.exist;",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-publishable-api-key",
						"value": "{{publishable_api_key}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"paymentIntentId\": null,\n    \"currency\": \"usd\",\n    \"amount\": 2000,\n    \"cartItems\": [\n        {\n            \"variantId\": \"{{variant_id}}\",\n            \"quantity\": 1\n        }\n    ],\n    \"hasCartItems\": true\n}"
				},
				"url": {
					"raw": "{{storefront_url}}/api/payment-intent",
					"host": [
						"{{storefront_url}}"
					],
					"path": [
						"api",
						"payment-intent"
					]
				}
			}
		}
	]
}

# Docker Compose for Grace Stowel Chaos Testing Environment
# Usage: docker-compose -f docker-compose.chaos.yml up -d
# Includes Toxiproxy for network chaos injection

version: "3.8"

services:
  # PostgreSQL Database (Chaos)
  postgres:
    image: postgres:16-alpine
    container_name: gracestowel-postgres-chaos
    environment:
      POSTGRES_USER: medusa_chaos
      POSTGRES_PASSWORD: medusa_chaos
      POSTGRES_DB: medusa_chaos
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U medusa_chaos -d medusa_chaos"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Redis Cache (Chaos)
  redis:
    image: redis:7-alpine
    container_name: gracestowel-redis-chaos
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Toxiproxy for Network Chaos Injection
  toxiproxy:
    image: ghcr.io/shopify/toxiproxy:2.9.0
    container_name: gracestowel-toxiproxy
    ports:
      - "8474:8474"   # Toxiproxy API
      - "5434:5434"   # Proxied Postgres
      - "6381:6381"   # Proxied Redis
      - "9002:9002"   # Proxied Backend
    volumes:
      - ./toxiproxy.json:/config/toxiproxy.json
    command: ["-config", "/config/toxiproxy.json"]
    depends_on:
      - postgres
      - redis

  # Medusa Backend (Chaos) - connects through Toxiproxy
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
      target: test
    container_name: gracestowel-backend-chaos
    depends_on:
      toxiproxy:
        condition: service_started
    environment:
      # Connect through Toxiproxy for chaos injection
      DATABASE_URL: postgresql://medusa_chaos:medusa_chaos@toxiproxy:5434/medusa_chaos
      REDIS_URL: redis://toxiproxy:6381
      JWT_SECRET: chaos-secret
      COOKIE_SECRET: chaos-secret
      STORE_CORS: http://localhost:5175,https://localhost:5175
      ADMIN_CORS: http://localhost:7003
      AUTH_CORS: http://localhost:5175,https://localhost:5175
      NODE_ENV: test
    ports:
      - "9003:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # Storefront (Chaos)
  storefront:
    build:
      context: ./apps/storefront
      dockerfile: Dockerfile
      target: test
    container_name: gracestowel-storefront-chaos
    depends_on:
      - backend
    environment:
      # Connect through Toxiproxy for chaos injection
      MEDUSA_BACKEND_URL: http://toxiproxy:9002
      NODE_ENV: test
    ports:
      - "5175:5173"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

networks:
  default:
    name: gracestowel-chaos-network


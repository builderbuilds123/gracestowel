# Sprint Change Proposal: Checkout Payment Flow Fixes

**Date:** 2025-12-12
**Author:** John (PM Agent) + Big Dick
**Status:** Completed ✅
**Completed:** 2025-12-13
**PR:** #55 (merged to staging)
**Scope:** Moderate
**Trace ID:** gt_scp_checkout_2025_12_12

---

## 1. Issue Summary

### Problem Statement
The checkout payment flow has multiple critical bugs causing payment failures, duplicate charges risk, and poor debuggability:

1. **Multiple PaymentIntents created** — Each cart/shipping change creates a NEW PaymentIntent instead of updating existing one
2. **PaymentIntent not persistent** — No session persistence; `clientSecret` changes break Stripe Elements
3. **Order not propagated to backend** — Webhook failures cause silent order creation failures
4. **Payment capture failures** — No retry logic or structured error handling
5. **No error tracing** — Cannot correlate errors across frontend → backend → Stripe

### Root Cause
The implementation violates Stripe's core best practice: **"create once, update as needed"** for PaymentIntents. The current code creates a new PaymentIntent on every `useEffect` trigger instead of reusing/updating the existing one.

### Discovery Context
- Discovered during: Implementation testing of Epic 1 (Stripe Integration)
- Affected Stories: 1.2, 1.4, 6.1, 8.1
- Business Impact: Payment failures, potential duplicate charges, poor customer experience

---

## 2. Impact Analysis

### Epic Impact

| Epic | Impact Level | Details |
|------|--------------|---------|
| Epic 1: Stripe Integration | HIGH | Stories 1.2, 1.4 need rework |
| Epic 2: Grace Period | MEDIUM | Depends on correct PaymentIntent handling |
| Epic 3: Order Editing | MEDIUM | `increment_authorization` requires stable base PI |
| Epic 6: Error Handling | HIGH | Needs expansion for payment-specific flows |
| Epic 8: Operational Excellence | HIGH | Story 8.1 (Structured Logging) critical |

---

## 3. Recommended Approach

**Selected Path:** Direct Adjustment (Option 1)

### Rationale
- Issues are implementation bugs, not architectural problems
- PRD and architecture are sound; code doesn't follow Stripe best practices
- Well-documented Stripe patterns to follow
- No rollback needed — fixes build on existing code

---

## 4. Detailed Change Proposals

### Change 1: PaymentIntent Lifecycle Management ✅ IMPLEMENTED

**Files:**
- `apps/storefront/app/routes/api.payment-intent.ts`
- `apps/storefront/app/routes/checkout.tsx`

**Changes:**
- Accept optional `paymentIntentId` parameter for reuse
- CREATE with server-generated idempotency key (deterministic from cart hash)
- UPDATE existing PaymentIntent when `paymentIntentId` provided
- Return both `clientSecret` and `paymentIntentId`
- Frontend stores `paymentIntentId` and reuses it
- Only set `clientSecret` once (prevents Elements breaking)
- Single `useEffect` manages create/update lifecycle with 300ms debounce

---

### Change 2: Structured Error Logging ✅ IMPLEMENTED

**Files:**
- `apps/storefront/app/lib/logger.ts` (NEW)
- Updates to payment routes

**Changes:**
- Create `createLogger()` utility with trace ID generation
- JSON-structured log output with timestamp, level, context
- Trace ID propagation via `x-trace-id` header
- Return trace ID in error responses for support reference
- Display trace ID to users on payment errors

---

### Change 3: Backend Order Propagation Fix ✅ IMPLEMENTED

**Files:**
- `apps/backend/src/loaders/stripe-event-worker.ts`

**Changes:**
- Add idempotency check before order creation
- Query for existing order with same `stripe_payment_intent_id`
- Skip creation if order already exists
- Add structured logging to webhook handler
- Re-throw errors so Stripe retries webhook

---

## 5. Implementation Summary

### Success Criteria ✅ ALL MET
- [x] Single PaymentIntent per checkout session (verify in Stripe Dashboard)
- [x] Cart/shipping changes UPDATE existing PI, not create new
- [x] Structured JSON logs with trace IDs in production
- [x] Webhook retries don't create duplicate orders
- [x] Error messages include trace ID for support

### CI/CD Results
- ✅ Backend Unit Tests - Passed
- ✅ Storefront Tests - Passed
- ✅ GitGuardian Security Checks - Passed
- ✅ Snyk Security - Passed
- ✅ Cloudflare Workers Build - Passed

### Review Bot Feedback Addressed
- ✅ Removed `Date.now()` from idempotency key (now truly deterministic)
- ✅ Added error logging to stock validation catch block
- ✅ Changed `handleAddressChange` to use `StripeAddressElementChangeEvent` type

---

## 6. Completion

**Story File:** `docs/sprint/sprint-artifacts/checkout-payment-flow-fixes.md`
**PR:** https://github.com/builderbuilds123/gracestowel/pull/55
**Merged:** 2025-12-13

---

_Generated by PM Agent (John) during Course Correction workflow_
_Stripe Power used for best practices research_
